
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core users (2 hardcoded users bootstrap)

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  role         String   @default("user") // user|admin
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile UserProfile?
  garmin  GarminAccount?

  manualDays    ManualDaily[]
  snapshots     GarminSnapshot[]
  briefs        AiBrief[]
  alerts        Alert[]
  emailVerified    Boolean @default(false)
  twoFactorEnabled Boolean @default(false)
  image            String?
  sessions         Session[]
  accounts         Account[]

  twoFactor TwoFactor?

  @@map("user")
}

model UserProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  sex String @default("male") // male|female

  // Goals (simple, editable)
  stepsGoal Int @default(8000)
  sleepGoalHours Float @default(7.5)

  // Optional female-specific context
  pregnant Boolean @default(false)

  // Simple cycle tracking (optional)
  // - cycleDay can be set manually OR computed client-side from lastPeriodStart + cycleLengthDays
  cycleDay Int?
  lastPeriodStart DateTime?
  cycleLengthDays Int?
  cycleSymptoms Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GarminAccount {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Tokens encrypted server-side with ENCRYPTION_KEY
  tokensEncrypted String
  tokensUpdatedAt DateTime @default(now())

  status    String  @default("ok") // ok|reauth_required|error
  lastError String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GarminSnapshot {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  day     String // YYYY-MM-DD
  takenAt DateTime // snapshot timestamp

  // Key metrics
  steps           Int?
  restingHr       Int?
  stressAvg       Int?
  sleepMinutes    Int?
  sleepHours      Float?
  bodyBatteryHigh Int?
  bodyBatteryLow  Int?
  spo2Avg         Float?
  spo2Low         Int?
  respAvgWaking   Float?
  respAvgSleep    Float?

  activityCount      Int?
  activityMinutes    Int?
  activityDistanceKm Float?
  activityCalories   Int?

  // Raw JSON (optional). Keep as Json for now; can move to object storage later.
  rawJson Json?

  createdAt DateTime @default(now())

  @@index([userId, day])
  @@index([userId, takenAt])
  @@unique([userId, takenAt])
}

model ManualDaily {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  day String // YYYY-MM-DD

  symptomScore Int? // 0-3
  caffeineCups Int?
  alcoholUnits Int?
  notes        String?
  trained      Boolean?
  meds         Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, day])
  @@index([userId, day])
}

model AiBrief {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  day         String
  risk        String // OK|LOW|MED|HIGH
  short       String
  signals     Json
  suggestions Json

  model String?

  createdAt DateTime @default(now())

  @@unique([userId, day])
  @@index([userId, day])
}

model Alert {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  day      String
  severity String // LOW|MED|HIGH
  title    String
  body     String

  deliveredAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId, day])
  @@index([deliveredAt])
  @@unique([userId, day, severity, title])
}

model TwoFactor {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  secret      String
  backupCodes String

  @@index([userId])
  @@map("twoFactor")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
